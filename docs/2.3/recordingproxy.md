## Recording Proxy

### Configure OpenSSH Servers

#### Allow Teleport User CA

To allow users to log in with certificates generated by the Teleport User CA, first connect to your Auth Server and export your User CA.

```
tctl auth export --type=user
```

To allow access to a single user, copy the above output to `~/.ssh/authorized_keys`.

To allow all users, remove `cert-authority` from the start of `tctl` output and copy it to `/etc/ssh/teleport_user_ca.pub`. Add the following line to `/etc/ssh/sshd_config`: `TrustedUserCAKeys /etc/ssh/teleport_user_ca.pub` and restart `sshd`.

#### Generate Host Certificate

It's recommended to use valid host certificates signed by the Teleport Host CA. To generate a host certificate connect to your Auth Server run the following command:

```
tctl auth gen \
    --type=host \
    --principal=node.example.com \
    --pub-key=/etc/ssh/teleport_host_key.pub \
    --priv-key=/etc/ssh/teleport_host_key \
    --cert=/etc/ssh/teleport_host_key-cert.pub
```

Then add the following lines to `/etc/ssh/sshd_config` and restart `sshd`.

```
HostKey /etc/ssh/teleport_host_key
HostCertificate /etc/ssh/teleport_host_key-cert.pub
```

#### Allow setting environment variables

To allow Teleport to set variables for session sharing and other purposes, update `/etc/ssh/sshd_config` to allow clients to set `SSH_*`.

```
AcceptEnv LANG LC_* SSH_*
```

### Configure OpenSSH Clients

#### Allow Teleport Host CA

To validate host certificates presented by OpenSSH nodes, connect to the Auth Server and export the Host CA.

```
tctl auth export --type=host
```

Add the above line to `~/.ssh/known_hosts` for a single user, or `/etc/ssh/ssh_known_hosts` for all users.

### Examples

#### Load Teleport User Certificate

Make sure to login to Teleport and load your certificates into your `ssh-agent`:

```bash
tsh --proxy=proxy.example.com --user=rjones login
```

#### Interactive Sessions

For obtain an interactive sessions (shell), use a command like the following:

```bash
ssh -o "ForwardAgent yes" \
    -o "ProxyCommand ssh -p 3023 %r@proxy.example.com -s proxy:%h:%p" \
    node.example.com
```

#### Exec

To run a command without a PTY:

```bash
ssh -o "ForwardAgent yes" \
    -o "ProxyCommand ssh -p 3023 %r@proxy.example.com -s proxy:%h:%p" \
    node.example.com date
```

To run a command with a PTY:

```bash
ssh -o "ForwardAgent yes" \
    -o "ProxyCommand ssh -p 3023 %r@proxy.example.com -s proxy:%h:%p" \
    -t node.example.com date
```

#### Subsystems

To run a subsystem:

```bash
SUBSYSTEM="foo"
ssh -o "ForwardAgent yes" \
    -o "ProxyCommand ssh -p 3023 %r@proxy.example.com -s proxy:%h:%p" \
    -t node.example.com -s $SUBSYSTEM
```

#### `scp` and `sftp` aliases

Note that some exec and subsystems like `scp` and `sftp` have special binaries that needed to run them. These binaries also by default disable agent forwarding which is needed because the proxy terminates the connection and then needs to use the forwarded agent to connect to the final destination. If you wish to use these commands with the recording proxy, an alias like the following would be useful.


```
alias sftp='sftp -S ./withagent.py'
alias scp='scp -S ./withagent.py'
```

Where `withagent.py` is below.


```python
#!/usr/bin/env python

import sys
import subprocess


def remove_no_forward(argv):
    args = argv[1:]

    remove_list = [
       "-oClearAllForwardings yes",
       "-oClearAllForwardings=yes",
       "-oForwardAgent no",
       "-oForwardAgent=no"]

    for remove_item in remove_list:
        if remove_item in args: args.remove(remove_item)

    return args


def build_command(args):
    ssh_path = ["/usr/bin/ssh"]
    proxy_command_arg = ["-o", "ProxyCommand ssh -p 3023 %r@proxy.example.com -s proxy:%h:%p"]

    return ssh_path + proxy_command_arg + args


if __name__ == "__main__":
    # strip deny of agent forwarding
    args = remove_no_forward(sys.argv)

    # build command to run
    argv = build_command(args)

    # debug command
    #sys.stderr.write(str(argv))

    # run command
    subprocess.call(argv)
```
